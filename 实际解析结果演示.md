# 实际解析结果演示

## 输入数据（评测模块回传的JSON）

```json
{
  "modelId": 123,
  "resultColumn": "robustnessResult",
  "result": {
    "robustness": "{\"adversarial\": [{\"attack\": \"fgsm\", \"eps\": 0.001, \"metrics\": {\"clean_map\": 0.86, \"adversarial_map\": 0.81, \"map_drop_rate\": 0.058, \"miss_rate\": 0.25, \"false_detection_rate\": 0.44, \"clean_miss_rate\": 0.23, \"clean_false_detection_rate\": 0.45, \"per_class_clean_map\": {\"1\": 0.98, \"2\": 0.85}, \"per_class_adversarial_map\": {\"1\": 0.97, \"2\": 0.78}}}, {\"attack\": \"pgd\", \"eps\": 0.003, \"metrics\": {\"clean_map\": 0.86, \"adversarial_map\": 0.75, \"map_drop_rate\": 0.128, \"miss_rate\": 0.32, \"false_detection_rate\": 0.51, \"clean_miss_rate\": 0.23, \"clean_false_detection_rate\": 0.45}}], \"corruption\": [{\"corruption_name\": \"gaussian_noise\", \"severity\": \"1\", \"perturbation_magnitude\": 0.04, \"performance_drop_rate\": 0.06, \"perturbation_tolerance\": 0.92}]}"
  }
}
```

---

## 解析过程

### 步骤1: 检查触发条件
```java
if (result.containsKey("robustness"))  // true
```
✅ 触发 `parseAndStoreRobustness(123, "robustnessResult", robustnessJson)`

### 步骤2: 解析 robustnessJson
```java
JsonNode rootNode = objectMapper.readTree(robustnessJson);
// 得到:
// {
//   "adversarial": [...],
//   "corruption": [...]
// }
```

### 步骤3: 处理 adversarial 数组

#### 3.1 第一个攻击 (FGSM)
```
attack = {
  "attack": "fgsm",
  "eps": 0.001,
  "metrics": {
    "clean_map": 0.86,
    "adversarial_map": 0.81,
    "map_drop_rate": 0.058,
    "miss_rate": 0.25,
    "false_detection_rate": 0.44,
    "clean_miss_rate": 0.23,
    "clean_false_detection_rate": 0.45,
    "per_class_clean_map": {"1": 0.98, "2": 0.85},
    "per_class_adversarial_map": {"1": 0.97, "2": 0.78}
  }
}

构造 attackName:
  attack.get("attack") = "fgsm"
  attack.has("eps") = true
  attack.get("eps") = 0.001
  ➜ attackName = "fgsm_eps_0.001"

提取 metricsNode:
  attack.has("metrics") = true
  ➜ metricsNode = attack.get("metrics")

黑名单过滤:
  excludedFields = ["attack", "eps", "steps", "attack_name"]

遍历 metricsNode.fields():
```

| 字段名 | 值 | 类型 | 是否排除 | 生成键名 | 存储值 |
|--------|-----|------|---------|---------|--------|
| clean_map | 0.86 | 标量 | ❌ | clean_map_fgsm_eps_0.001 | "0.86" |
| adversarial_map | 0.81 | 标量 | ❌ | adversarial_map_fgsm_eps_0.001 | "0.81" |
| map_drop_rate | 0.058 | 标量 | ❌ | map_drop_rate_fgsm_eps_0.001 | "0.058" |
| miss_rate | 0.25 | 标量 | ❌ | miss_rate_fgsm_eps_0.001 | "0.25" |
| false_detection_rate | 0.44 | 标量 | ❌ | false_detection_rate_fgsm_eps_0.001 | "0.44" |
| clean_miss_rate | 0.23 | 标量 | ❌ | clean_miss_rate_fgsm_eps_0.001 | "0.23" |
| clean_false_detection_rate | 0.45 | 标量 | ❌ | clean_false_detection_rate_fgsm_eps_0.001 | "0.45" |
| per_class_clean_map | {"1":0.98,"2":0.85} | 对象 | ❌ | per_class_clean_map_fgsm_eps_0.001 | "{\"1\":0.98,\"2\":0.85}" |
| per_class_adversarial_map | {"1":0.97,"2":0.78} | 对象 | ❌ | per_class_adversarial_map_fgsm_eps_0.001 | "{\"1\":0.97,\"2\":0.78}" |

**FGSM 共存储: 9 个字段**

#### 3.2 第二个攻击 (PGD)
```
attack = {
  "attack": "pgd",
  "eps": 0.003,
  "metrics": {
    "clean_map": 0.86,
    "adversarial_map": 0.75,
    "map_drop_rate": 0.128,
    "miss_rate": 0.32,
    "false_detection_rate": 0.51,
    "clean_miss_rate": 0.23,
    "clean_false_detection_rate": 0.45
  }
}

attackName = "pgd_eps_0.003"
```

| 字段名 | 生成键名 | 存储值 |
|--------|---------|--------|
| clean_map | clean_map_pgd_eps_0.003 | "0.86" |
| adversarial_map | adversarial_map_pgd_eps_0.003 | "0.75" |
| map_drop_rate | map_drop_rate_pgd_eps_0.003 | "0.128" |
| miss_rate | miss_rate_pgd_eps_0.003 | "0.32" |
| false_detection_rate | false_detection_rate_pgd_eps_0.003 | "0.51" |
| clean_miss_rate | clean_miss_rate_pgd_eps_0.003 | "0.23" |
| clean_false_detection_rate | clean_false_detection_rate_pgd_eps_0.003 | "0.45" |

**PGD 共存储: 7 个字段**

### 步骤4: 处理 corruption 数组

```
corruption = {
  "corruption_name": "gaussian_noise",
  "severity": "1",
  "perturbation_magnitude": 0.04,
  "performance_drop_rate": 0.06,
  "perturbation_tolerance": 0.92
}

构造 suffix:
  corruptionName = "gaussian_noise"
  severity = "1"
  ➜ suffix = "gaussian_noise_1"

黑名单过滤:
  excludedFields = ["corruption_name", "corruption_key", "severity"]
```

| 字段名 | 是否排除 | 生成键名 | 存储值 |
|--------|---------|---------|--------|
| corruption_name | ✅ 排除 | - | - |
| severity | ✅ 排除 | - | - |
| perturbation_magnitude | ❌ | perturbation_magnitude_gaussian_noise_1 | "0.04" |
| performance_drop_rate | ❌ | performance_drop_rate_gaussian_noise_1 | "0.06" |
| perturbation_tolerance | ❌ | perturbation_tolerance_gaussian_noise_1 | "0.92" |

**Corruption 共存储: 3 个字段**

---

## 最终数据库存储结果

### 表: `model_evaluation`
### 列: `robustnessResult`
### modelId: 123

```json
{
  "clean_map_fgsm_eps_0.001": "0.86",
  "adversarial_map_fgsm_eps_0.001": "0.81",
  "map_drop_rate_fgsm_eps_0.001": "0.058",
  "miss_rate_fgsm_eps_0.001": "0.25",
  "false_detection_rate_fgsm_eps_0.001": "0.44",
  "clean_miss_rate_fgsm_eps_0.001": "0.23",
  "clean_false_detection_rate_fgsm_eps_0.001": "0.45",
  "per_class_clean_map_fgsm_eps_0.001": "{\"1\":0.98,\"2\":0.85}",
  "per_class_adversarial_map_fgsm_eps_0.001": "{\"1\":0.97,\"2\":0.78}",
  "clean_map_pgd_eps_0.003": "0.86",
  "adversarial_map_pgd_eps_0.003": "0.75",
  "map_drop_rate_pgd_eps_0.003": "0.128",
  "miss_rate_pgd_eps_0.003": "0.32",
  "false_detection_rate_pgd_eps_0.003": "0.51",
  "clean_miss_rate_pgd_eps_0.003": "0.23",
  "clean_false_detection_rate_pgd_eps_0.003": "0.45",
  "perturbation_magnitude_gaussian_noise_1": "0.04",
  "performance_drop_rate_gaussian_noise_1": "0.06",
  "perturbation_tolerance_gaussian_noise_1": "0.92"
}
```

### 统计:
- **总字段数**: 19
- **FGSM 攻击**: 9 个字段
- **PGD 攻击**: 7 个字段
- **Gaussian Noise 腐败**: 3 个字段
- **丢失字段**: 0

---

## 攻击方法识别验证

### 示例1: 从键名提取 FGSM 攻击信息
```
键名: "clean_map_fgsm_eps_0.001"
分割: ["clean", "map", "fgsm", "eps", "0.001"]

提取:
  指标名: clean_map
  攻击方法: fgsm
  参数类型: eps
  参数值: 0.001
```

### 示例2: 从键名提取 PGD 攻击信息
```
键名: "map_drop_rate_pgd_eps_0.003"
分割: ["map", "drop", "rate", "pgd", "eps", "0.003"]

提取:
  指标名: map_drop_rate
  攻击方法: pgd
  参数类型: eps
  参数值: 0.003
```

### 示例3: 从键名提取腐败测试信息
```
键名: "perturbation_magnitude_gaussian_noise_1"
分割: ["perturbation", "magnitude", "gaussian", "noise", "1"]

提取:
  指标名: perturbation_magnitude
  腐败类型: gaussian_noise
  严重程度: 1
```

---

## 对比旧方法

### 旧方法（白名单）存储结果:
```json
{
  "map_drop_rate_fgsm_eps_0.001": "0.058",
  "miss_rate_fgsm_eps_0.001": "0.25",
  "false_detection_rate_fgsm_eps_0.001": "0.44",
  "map_drop_rate_pgd_eps_0.003": "0.128",
  "miss_rate_pgd_eps_0.003": "0.32",
  "false_detection_rate_pgd_eps_0.003": "0.51",
  "perturbation_magnitude_gaussian_noise_1": "0.04",
  "performance_drop_rate_gaussian_noise_1": "0.06",
  "perturbation_tolerance_gaussian_noise_1": "0.92"
}
```
**仅 9 个字段，丢失 10 个重要指标**

### 新方法（黑名单）存储结果:
```json
{
  // 上面展示的完整 19 个字段
}
```
**完整 19 个字段，0 丢失**

---

## 结论

✅ **解析成功**: 19 个指标字段完整存储
✅ **攻击识别**: 可以从键名完全识别攻击方法和参数
✅ **格式一致**: 与其他评测维度（basicResult等）格式保持一致
✅ **嵌套对象**: per_class_* 字段正确序列化为JSON字符串
✅ **无信息丢失**: 所有重要指标都被保留
